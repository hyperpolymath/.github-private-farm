# SPDX-License-Identifier: AGPL-3.0-or-later
# SLSA Provenance Generation
# Generates SLSA Level 3 provenance for releases
# https://slsa.dev/

name: SLSA Provenance

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag to generate provenance for'
        required: true
        type: string

permissions:
  contents: read
  id-token: write
  attestations: write

jobs:
  # ═══════════════════════════════════════════════════════════════════════════
  # Build with provenance
  # ═══════════════════════════════════════════════════════════════════════════
  build:
    runs-on: ubuntu-latest
    outputs:
      hashes: ${{ steps.hash.outputs.hashes }}
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v4.1.7
        with:
          fetch-depth: 0

      - name: Build artifacts
        id: build
        run: |
          # Create reproducible build artifacts
          # Modify this for your actual build process

          mkdir -p dist

          # Example: Create source archive
          VERSION="${{ github.event.release.tag_name || inputs.version }}"
          git archive --format=tar.gz --prefix="RSR-template-repo-${VERSION}/" \
            -o "dist/RSR-template-repo-${VERSION}.tar.gz" HEAD

          # Example: Create checksums
          cd dist
          sha256sum *.tar.gz > SHA256SUMS.txt
          sha512sum *.tar.gz > SHA512SUMS.txt

      - name: Generate hashes
        id: hash
        run: |
          cd dist
          echo "hashes=$(sha256sum *.tar.gz | base64 -w0)" >> "$GITHUB_OUTPUT"

      - name: Upload artifacts
        uses: actions/upload-artifact@5d5d22a31266ced268874388b861e4b58bb5c2f3 # v4.3.1
        with:
          name: build-artifacts
          path: dist/
          retention-days: 5

  # ═══════════════════════════════════════════════════════════════════════════
  # Generate SLSA provenance
  # ═══════════════════════════════════════════════════════════════════════════
  provenance:
    needs: [build]
    permissions:
      actions: read
      id-token: write
      contents: write
    uses: slsa-framework/slsa-github-generator/.github/workflows/generator_generic_slsa3.yml@v2.0.0
    with:
      base64-subjects: "${{ needs.build.outputs.hashes }}"
      upload-assets: true
      provenance-name: "RSR-template-repo.intoto.jsonl"

  # ═══════════════════════════════════════════════════════════════════════════
  # Verify provenance (self-test)
  # ═══════════════════════════════════════════════════════════════════════════
  verify:
    needs: [build, provenance]
    runs-on: ubuntu-latest
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@c850b930e6ba138125429b7e5c93fc707a7f8427 # v4.1.4
        with:
          name: build-artifacts
          path: dist/

      - name: Download provenance
        uses: actions/download-artifact@c850b930e6ba138125429b7e5c93fc707a7f8427 # v4.1.4
        with:
          name: RSR-template-repo.intoto.jsonl
          path: provenance/

      - name: Install slsa-verifier
        uses: slsa-framework/slsa-verifier/actions/installer@v2.5.1

      - name: Verify provenance
        run: |
          slsa-verifier verify-artifact \
            --provenance-path provenance/RSR-template-repo.intoto.jsonl \
            --source-uri github.com/${{ github.repository }} \
            dist/*.tar.gz

      - name: Verification summary
        run: |
          echo "## SLSA Provenance Verification" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ All artifacts verified successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Artifact | SHA256 |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          cat dist/SHA256SUMS.txt | while read hash file; do
            echo "| \`$file\` | \`${hash:0:16}...\` |" >> $GITHUB_STEP_SUMMARY
          done

  # ═══════════════════════════════════════════════════════════════════════════
  # Upload to release (if triggered by release)
  # ═══════════════════════════════════════════════════════════════════════════
  release:
    if: github.event_name == 'release'
    needs: [build, provenance, verify]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@c850b930e6ba138125429b7e5c93fc707a7f8427 # v4.1.4
        with:
          path: artifacts/

      - name: Upload release assets
        uses: softprops/action-gh-release@9d7c94cfd0a1f3ed45544c887983e9fa900f0564 # v2.0.4
        with:
          files: |
            artifacts/build-artifacts/*
            artifacts/RSR-template-repo.intoto.jsonl/*
